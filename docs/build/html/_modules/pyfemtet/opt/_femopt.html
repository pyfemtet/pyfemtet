<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyfemtet.opt._femopt &mdash; PyFemtet Project  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/design-tabs.js?v=36754332"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            PyFemtet Project
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pages/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pages/examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pages/advanced_examples.html">Advanced Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pages/script_builder.html">GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pages/usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pages/api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pages/LICENSE.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PyFemtet Project</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pyfemtet.opt._femopt</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyfemtet.opt._femopt</h1><div class="highlight"><pre>
<span></span><span class="c1"># built-in</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">SupportsFloat</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">traceback</span> <span class="kn">import</span> <span class="n">print_exception</span>

<span class="c1"># 3rd-party</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">LocalCluster</span><span class="p">,</span> <span class="n">Client</span><span class="p">,</span> <span class="n">get_worker</span><span class="p">,</span> <span class="n">Nanny</span>

<span class="c1"># pyfemtet relative</span>
<span class="kn">from</span> <span class="nn">pyfemtet.opt.interface</span> <span class="kn">import</span> <span class="n">FEMInterface</span><span class="p">,</span> <span class="n">FemtetInterface</span>
<span class="kn">from</span> <span class="nn">pyfemtet.opt.optimizer</span> <span class="kn">import</span> <span class="n">AbstractOptimizer</span><span class="p">,</span> <span class="n">OptunaOptimizer</span>
<span class="kn">from</span> <span class="nn">pyfemtet.opt.visualization._process_monitor.application</span> <span class="kn">import</span> <span class="n">main</span> <span class="k">as</span> <span class="n">process_monitor_main</span>
<span class="kn">from</span> <span class="nn">pyfemtet.opt._femopt_core</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_check_bound</span><span class="p">,</span>
    <span class="n">_is_access_gogh</span><span class="p">,</span>
    <span class="n">_is_access_femtet</span><span class="p">,</span>
    <span class="n">Objective</span><span class="p">,</span>
    <span class="n">Constraint</span><span class="p">,</span>
    <span class="n">History</span><span class="p">,</span>
    <span class="n">OptimizationStatus</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">,</span>
    <span class="n">MonitorHostRecord</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyfemtet._message</span> <span class="kn">import</span> <span class="n">Msg</span><span class="p">,</span> <span class="n">encoding</span>
<span class="kn">from</span> <span class="nn">pyfemtet.opt.optimizer.parameter</span> <span class="kn">import</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">Expression</span>
<span class="kn">from</span> <span class="nn">pyfemtet._warning</span> <span class="kn">import</span> <span class="n">experimental_feature</span>

<span class="kn">from</span> <span class="nn">dask</span> <span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">cfg</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">set</span><span class="p">({</span><span class="s1">&#39;distributed.scheduler.worker-ttl&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>


<span class="k">def</span> <span class="nf">add_worker</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">worker_name</span><span class="p">,</span> <span class="n">n_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">DEVNULL</span><span class="p">,</span> <span class="n">PIPE</span>

    <span class="n">current_n_workers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">nthreads</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">Popen</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="si">}</span><span class="s1"> -m dask worker &#39;</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">client</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">address</span><span class="si">}</span><span class="s1"> &#39;</span>
        <span class="sa">f</span><span class="s1">&#39;--nthreads 1 &#39;</span>
        <span class="sa">f</span><span class="s1">&#39;--nworkers </span><span class="si">{</span><span class="n">n_workers</span><span class="si">}</span><span class="s1"> &#39;</span>
        <span class="sa">f</span><span class="s1">&#39;--name </span><span class="si">{</span><span class="n">worker_name</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">,</span>  <span class="c1"># A unique name for this worker like ‘worker-1’. If used with -nworkers then the process number will be appended like name-0, name-1, name-2, …</span>
        <span class="c1"># --no-nanny option は --nworkers と併用できない</span>
        <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># worker が増えるまで待つ</span>
    <span class="n">client</span><span class="o">.</span><span class="n">wait_for_workers</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="n">current_n_workers</span> <span class="o">+</span> <span class="n">n_workers</span><span class="p">)</span>


<div class="viewcode-block" id="FEMOpt">
<a class="viewcode-back" href="../../../modules/pyfemtet.opt.html#pyfemtet.opt.FEMOpt">[docs]</a>
<span class="k">class</span> <span class="nc">FEMOpt</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class to control FEM interface and optimizer.</span>

<span class="sd">    Args:</span>
<span class="sd">        fem (FEMInterface, optional):</span>
<span class="sd">            The FEM software interface.</span>
<span class="sd">            Defaults to None (automatically set to :class:`FemtetInterface`).</span>

<span class="sd">        opt (AbstractOptimizer, optional):</span>
<span class="sd">            The numerical optimizer object.</span>
<span class="sd">            Defaults to None (automatically set to :class:`OptunaOptimizer`</span>
<span class="sd">            with :class:`optuna.samplers.TPESampler`).</span>

<span class="sd">        history_path (str, optional):</span>
<span class="sd">            The path to the history file.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">            If None, &#39;%Y_%m_%d_%H_%M_%S.csv&#39; is created in current directory.</span>

<span class="sd">        scheduler_address (str, optional):</span>
<span class="sd">            When performing cluster computing, please specify the address</span>
<span class="sd">            of the scheduler computer here.</span>

<span class="sd">            See Also:</span>
<span class="sd">                https://pyfemtet.readthedocs.io/en/stable/pages/usage_pages/how_to_deploy_cluster.html</span>

<span class="sd">    .. Example の中について、reST ではリストだと改行できないので、リストにしない</span>

<span class="sd">    Examples:</span>

<span class="sd">        When specifying and opening a femprj and model, we write</span>

<span class="sd">            &gt;&gt;&gt; from pyfemtet.opt import FEMOpt, FemtetInterface  # doctest: +SKIP</span>
<span class="sd">            &gt;&gt;&gt; fem = FemtetInterface(femprj_path=&#39;path/to/project.femprj&#39;, model_name=&#39;NewModel&#39;)  # doctest: +SKIP</span>
<span class="sd">            &gt;&gt;&gt; femopt = FEMOpt(fem=fem)  # doctest: +SKIP</span>

<span class="sd">        When specifying optimization algorithm, we write</span>

<span class="sd">            &gt;&gt;&gt; from optuna.samplers import TPESampler  # doctest: +SKIP</span>
<span class="sd">            &gt;&gt;&gt; from pyfemtet.opt import FEMOpt, OptunaOptimizer  # doctest: +SKIP</span>
<span class="sd">            &gt;&gt;&gt; opt = OptunaOptimizer(sampler_class=TPESampler, sampler_kwargs=dict(n_startup_trials=10))  # doctest: +SKIP</span>
<span class="sd">            &gt;&gt;&gt; femopt = FEMOpt(opt=opt)  # doctest: +SKIP</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">fem</span><span class="p">:</span> <span class="n">FEMInterface</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">opt</span><span class="p">:</span> <span class="n">AbstractOptimizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">history_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">scheduler_address</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initialize FEMOpt&#39;</span><span class="p">)</span>

        <span class="c1"># 引数の処理</span>
        <span class="k">if</span> <span class="n">history_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">history_path</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S.csv&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">history_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler_address</span> <span class="o">=</span> <span class="n">scheduler_address</span>

        <span class="k">if</span> <span class="n">fem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fem</span> <span class="o">=</span> <span class="n">FemtetInterface</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fem</span> <span class="o">=</span> <span class="n">fem</span>

        <span class="k">if</span> <span class="n">opt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">:</span> <span class="n">AbstractOptimizer</span> <span class="o">=</span> <span class="n">OptunaOptimizer</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">:</span> <span class="n">AbstractOptimizer</span> <span class="o">=</span> <span class="n">opt</span>

        <span class="c1"># メンバーの宣言</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># actor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># actor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_status_list</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># [actor]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_process_future</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_server_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_process_worker_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_host_record</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hv_reference</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_space_dir</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># multiprocess 時に pickle できないオブジェクト参照の削除</span>
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;fem&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<div class="viewcode-block" id="FEMOpt.set_random_seed">
<a class="viewcode-back" href="../../../modules/pyfemtet.opt.html#pyfemtet.opt.FEMOpt.set_random_seed">[docs]</a>
    <span class="k">def</span> <span class="nf">set_random_seed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the random seed for reproducibility.</span>

<span class="sd">        Args:</span>
<span class="sd">            seed (int): The random seed value to be set.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span></div>


<div class="viewcode-block" id="FEMOpt.add_parameter">
<a class="viewcode-back" href="../../../modules/pyfemtet.opt.html#pyfemtet.opt.FEMOpt.add_parameter">[docs]</a>
    <span class="k">def</span> <span class="nf">add_parameter</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">initial_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">lower_bound</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">upper_bound</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">step</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">properties</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">pass_to_fem</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">fix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># noinspection PyUnresolvedReferences</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds a parameter to the optimization problem.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): The name of the parameter.</span>
<span class="sd">            initial_value (float, optional): The initial value of the parameter. Defaults to None. If None, try to get initial value from FEMInterface.</span>
<span class="sd">            lower_bound (float, optional): The lower bound of the parameter. Defaults to None. Some optimization algorithms require this.</span>
<span class="sd">            upper_bound (float or None, optional): The upper bound of the parameter. Defaults to None. Some optimization algorithms require this.</span>
<span class="sd">            step (float, optional): The step of parameter. If specified, parameter is used as discrete. Defaults to None.</span>
<span class="sd">            properties (dict[str, str or float], optional): Additional information about the parameter. Defaults to None.</span>
<span class="sd">            pass_to_fem (bool, optional): If this variable is used directly in FEM model update or not. If False, this parameter can be just used as inpt of expressions. Defaults to True.</span>
<span class="sd">            fix (bool, optiona):</span>
<span class="sd">                パラメータを initial_value で固定します。</span>
<span class="sd">                開発時にパラメータを振るか振らないかを</span>
<span class="sd">                簡単に変更するための便利引数です。</span>
<span class="sd">                True のとき、lower_bound, upper_bound, step, properties の</span>
<span class="sd">                値は、有効かどうかのチェックには使われますが、最適化では</span>
<span class="sd">                使われなくなります。</span>
<span class="sd">                デフォルトは False です。</span>


<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If initial_value is not specified and the value for the given name is also not specified in FEM.</span>

<span class="sd">        Examples:</span>

<span class="sd">            When adding parameter a (-1 &lt;= a &lt;= 1; initial value is 0), we write</span>

<span class="sd">                &gt;&gt;&gt; femopt.add_parameter(&#39;parameter_a&#39;, 0, -1, 1)  # doctest: +SKIP</span>

<span class="sd">                Note that the ```note``` argument can be set any name in this case.</span>

<span class="sd">            When adding discrete parameter a (-1 &lt;= a &lt;= 1; initial value is 0,</span>
<span class="sd">            step 0.5), we write</span>

<span class="sd">                &gt;&gt;&gt; femopt.add_parameter(&#39;parameter a&#39;, 0, -1, 1, 0.5)  # doctest: +SKIP</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_check_bound</span><span class="p">(</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pass_to_fem</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">check_param_value</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">initial_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">initial_value</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;initial_value を指定してください.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">initial_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;initial_value を指定してください.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fix</span><span class="p">:</span>
            <span class="n">prm</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">initial_value</span><span class="p">),</span>
                <span class="n">lower_bound</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">lower_bound</span><span class="p">)</span> <span class="k">if</span> <span class="n">lower_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">upper_bound</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">upper_bound</span><span class="p">)</span> <span class="k">if</span> <span class="n">upper_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">step</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">pass_to_fem</span><span class="o">=</span><span class="n">pass_to_fem</span><span class="p">,</span>
                <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="n">prm</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;The function &#39;add_expression&#39; is experimental&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_expression</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">fun</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">initial_value</span><span class="p">,</span>
                <span class="n">pass_to_fem</span><span class="o">=</span><span class="n">pass_to_fem</span><span class="p">,</span>
                <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
            <span class="p">)</span></div>



<div class="viewcode-block" id="FEMOpt.add_expression">
<a class="viewcode-back" href="../../../modules/pyfemtet.opt.html#pyfemtet.opt.FEMOpt.add_expression">[docs]</a>
    <span class="nd">@experimental_feature</span>
    <span class="k">def</span> <span class="nf">add_expression</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">fun</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">float</span><span class="p">],</span>
            <span class="n">properties</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">pass_to_fem</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># noinspection PyUnresolvedReferences</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add expression to the optimization problem.</span>

<span class="sd">        Warnings:</span>
<span class="sd">            This feature is highly experimental and</span>
<span class="sd">            may change in the future.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): The name of the variable.</span>
<span class="sd">            fun (Callable[[Any], float]): An expression function. The arguments that you want to use as input variables must be the same with ``name`` of Variable objects added by ``add_parameter()`` or ``add_expression()``. If you use other objects as argument of the function, you must specify ``kwargs``.</span>
<span class="sd">            properties (dict[str, str or float], optional): Additional information about the parameter. Defaults to None.</span>
<span class="sd">            kwargs (Optional[dict], optional): Remaining arguments of ``fun``. Defaults to None.</span>
<span class="sd">            pass_to_fem (bool, optional): If this variable is used directly in FEM model update or not. If False, this variable can be just used as inpt of other expressions. Defaults to True.</span>

<span class="sd">        Examples:</span>

<span class="sd">            When adding variable a and b; a is not directly included as model</span>
<span class="sd">            variables but an optimization parameter, b is not a parameter but</span>
<span class="sd">            a model variable and the relationship of these 2 variables is</span>
<span class="sd">            ```b = a ** 2```, we write:</span>

<span class="sd">                &gt;&gt;&gt; def calc_b(parameter_a):  # doctest: +SKIP</span>
<span class="sd">                ...     return parameter_a ** 2  # doctest: +SKIP</span>
<span class="sd">                ...</span>
<span class="sd">                &gt;&gt;&gt; femopt.add_parameter(&#39;parameter_a&#39;, 0, -1, 1, pass_to_fem=False)  # doctest: +SKIP</span>
<span class="sd">                &gt;&gt;&gt; femopt.add_expression(&#39;variable_b&#39;, calc_b)  # doctest: +SKIP</span>

<span class="sd">                Notes:</span>
<span class="sd">                    The argument names of function to calculate variable</span>
<span class="sd">                    must match the ```name``` of the parameter.</span>

<span class="sd">                Notes:</span>
<span class="sd">                    In this case, only strings that can be used as Python variables are valid</span>
<span class="sd">                    for ```name``` argument of :func:`FEMOpt.add_parameter`.</span>

<span class="sd">            When adding variable r, theta and x, y; r, theta is an optimization</span>
<span class="sd">            parameter and x, y is an intermediate variable to calculate constraint</span>
<span class="sd">            function, we write</span>

<span class="sd">                &gt;&gt;&gt; def calc_x(r, theta):  # doctest: +SKIP</span>
<span class="sd">                ...     return r * cos(theta)  # doctest: +SKIP</span>
<span class="sd">                ...</span>
<span class="sd">                &gt;&gt;&gt; def calc_y(r, theta):  # doctest: +SKIP</span>
<span class="sd">                ...     return r * cos(theta)  # doctest: +SKIP</span>
<span class="sd">                ...</span>
<span class="sd">                &gt;&gt;&gt; def constraint(Femtet, opt: AbstractOptimizer):  # doctest: +SKIP</span>
<span class="sd">                ...     d = opt.variables.get_variables()  # doctest: +SKIP</span>
<span class="sd">                ...     x, y = d[&#39;x&#39;], d[&#39;y&#39;]  # doctest: +SKIP</span>
<span class="sd">                ...     return min(x, y)  # doctest: +SKIP</span>
<span class="sd">                ...</span>
<span class="sd">                &gt;&gt;&gt; femopt.add_parameter(&#39;r&#39;, 0, 0, 1)  # doctest: +SKIP</span>
<span class="sd">                &gt;&gt;&gt; femopt.add_parameter(&#39;theta&#39;, 0, 0, 2*pi)  # doctest: +SKIP</span>
<span class="sd">                &gt;&gt;&gt; femopt.add_expression(&#39;x&#39;, calc_x, pass_to_fem=False)  # doctest: +SKIP</span>
<span class="sd">                &gt;&gt;&gt; femopt.add_expression(&#39;y&#39;, calc_y, pass_to_fem=False)  # doctest: +SKIP</span>
<span class="sd">                &gt;&gt;&gt; femopt.add_constraint(constraint, lower_bound=0.5, args=(femopt.opt,))  # doctest: +SKIP</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">exp</span> <span class="o">=</span> <span class="n">Expression</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
            <span class="n">fun</span><span class="o">=</span><span class="n">fun</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">{},</span>
            <span class="n">pass_to_fem</span><span class="o">=</span><span class="n">pass_to_fem</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">add_expression</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span></div>


<div class="viewcode-block" id="FEMOpt.add_objective">
<a class="viewcode-back" href="../../../modules/pyfemtet.opt.html#pyfemtet.opt.FEMOpt.add_objective">[docs]</a>
    <span class="k">def</span> <span class="nf">add_objective</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">fun</span><span class="p">:</span> <span class="nb">callable</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="nb">float</span> <span class="o">=</span> <span class="s1">&#39;minimize&#39;</span><span class="p">,</span>
            <span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="c1"># noinspection PyUnresolvedReferences</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds an objective to the optimization problem.</span>

<span class="sd">        Args:</span>
<span class="sd">            fun (callable or None, optional): The objective function. This argument is optional but</span>
<span class="sd">            name (str or None, optional): The name of the objective. Defaults to None.</span>
<span class="sd">            direction (str or float, optional): The optimization direction. Varid values are &#39;maximize&#39;, &#39;minimize&#39; or a float value. Defaults to &#39;minimize&#39;.</span>
<span class="sd">            args (tuple or None, optional): Additional arguments for the objective function. Defaults to None.</span>
<span class="sd">            kwargs (dict or None, optional): Additional keyword arguments for the objective function. Defaults to None.</span>

<span class="sd">        Note:</span>
<span class="sd">            If the FEMInterface is FemtetInterface, the 1st argument of fun should be Femtet (IPyDispatch) object.</span>

<span class="sd">        Examples:</span>

<span class="sd">            When add a complex objective (for example, want to dynamically set body</span>
<span class="sd">            to calculate temperature and use product of the temperature and one of</span>
<span class="sd">            the parameters as objective) , we write</span>

<span class="sd">                &gt;&gt;&gt; class MyClass:  # doctest: +SKIP</span>
<span class="sd">                ...     def get_body_name(self):  # doctest: +SKIP</span>
<span class="sd">                ...         ...  # process something and detect body name  # doctest: +SKIP</span>
<span class="sd">                ...         return body_name  # doctest: +SKIP</span>
<span class="sd">                ...</span>
<span class="sd">                &gt;&gt;&gt; def complex_objective(Femtet, opt, some_object):  # doctest: +SKIP</span>
<span class="sd">                ...     body_name = some_object.get_body_name()  # dynamically get body name to calculate temperature  # doctest: +SKIP</span>
<span class="sd">                ...     temp, _, _ = Femtet.Gogh.Watt.GetTemp(body_name)  # calculate temperature  # doctest: +SKIP</span>
<span class="sd">                ...     some_param = opt.get_parameter()[&#39;some_param&#39;]  # get ome parameter  # doctest: +SKIP</span>
<span class="sd">                ...     return temp * some_param  # calculate something and return it  # doctest: +SKIP</span>
<span class="sd">                ...</span>
<span class="sd">                &gt;&gt;&gt; my_obj = MyClass()  # doctest: +SKIP</span>
<span class="sd">                &gt;&gt;&gt; femopt.add_objective(complex_objective, args=(femopt.opt, my_obj,))  # doctest: +SKIP</span>

<span class="sd">        Tip:</span>
<span class="sd">            If name is None, name is a string with the prefix `&quot;obj_&quot;` followed by a sequential number.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 引数の処理</span>
        <span class="k">if</span> <span class="n">fun</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pyfemtet.opt.interface</span> <span class="kn">import</span> <span class="n">SurrogateModelInterfaceBase</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fem</span><span class="p">,</span> <span class="n">SurrogateModelInterfaceBase</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`fun` argument is not specified.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">,)</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">Objective</span><span class="o">.</span><span class="n">default_name</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">is_existing</span> <span class="o">=</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">objectives</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_existing</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">candidate</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">objectives</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Objective</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="FEMOpt.add_objectives">
<a class="viewcode-back" href="../../../modules/pyfemtet.opt.html#pyfemtet.opt.FEMOpt.add_objectives">[docs]</a>
    <span class="k">def</span> <span class="nf">add_objectives</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">fun</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">SupportsFloat</span><span class="p">]],</span>
            <span class="n">n_return</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">names</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">directions</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pyfemtet.opt._femopt_core</span> <span class="kn">import</span> <span class="n">ObjectivesFunc</span>
        <span class="n">components</span> <span class="o">=</span> <span class="n">ObjectivesFunc</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">n_return</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_return</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># names = names</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_return</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">directions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">directions</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">directions</span> <span class="o">=</span> <span class="p">[</span><span class="n">directions</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_return</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># directions = directions</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">directions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;minimize&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_return</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">directions</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span>
                <span class="n">fun</span><span class="o">=</span><span class="n">component</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="FEMOpt.add_constraint">
<a class="viewcode-back" href="../../../modules/pyfemtet.opt.html#pyfemtet.opt.FEMOpt.add_constraint">[docs]</a>
    <span class="k">def</span> <span class="nf">add_constraint</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">fun</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">lower_bound</span><span class="p">:</span> <span class="nb">float</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">upper_bound</span><span class="p">:</span> <span class="nb">float</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">using_fem</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># noinspection PyUnresolvedReferences</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds a constraint to the optimization problem.</span>

<span class="sd">        Args:</span>
<span class="sd">            fun (callable): The constraint function.</span>
<span class="sd">            name (str or None, optional): The name of the constraint. Defaults to None.</span>
<span class="sd">            lower_bound (float or Non, optional): The lower bound of the constraint. Defaults to None.</span>
<span class="sd">            upper_bound (float or Non, optional): The upper bound of the constraint. Defaults to None.</span>
<span class="sd">            strict (bool, optional): Flag indicating if it is a strict constraint. Defaults to True.</span>
<span class="sd">            args (tuple or None, optional): Additional arguments for the constraint function. Defaults to None.</span>
<span class="sd">            kwargs (dict): Additional arguments for the constraint function. Defaults to None.</span>
<span class="sd">            using_fem (bool, optional): Using FEM or not in the constraint function. It may make the processing time in strict constraints in BoTorchSampler. Defaults to None. If None, PyFemtet checks the access to Femtet and estimate using Femtet or not automatically.</span>

<span class="sd">        Warnings:</span>

<span class="sd">            When ```strict``` == True and using OptunaOptimizer along with :class:`PoFBoTorchSampler`,</span>
<span class="sd">            PyFemtet will solve an optimization subproblem to propose new variables.</span>
<span class="sd">            During this process, the constraint function ```fun``` will be executed at each</span>
<span class="sd">            iteration of the subproblem, which may include time-consuming operations such</span>
<span class="sd">            as retrieving 3D model information via FEMInterface.</span>
<span class="sd">            As a result, it may not be feasible to complete the overall optimization within</span>
<span class="sd">            a realistic timeframe.</span>

<span class="sd">            Examples:</span>
<span class="sd">                For example, in a case where the bottom area of the model is constrained,</span>
<span class="sd">                the following approach may require a very long time.</span>

<span class="sd">                    &gt;&gt;&gt; def bottom_area(Femtet, opt):  # doctest: +SKIP</span>
<span class="sd">                    ...     w = Femtet.GetVariableValue(&#39;width&#39;)  # doctest: +SKIP</span>
<span class="sd">                    ...     d = Femtet.GetVariableValue(&#39;depth&#39;)  # doctest: +SKIP</span>
<span class="sd">                    ...     return w * d  # doctest: +SKIP</span>
<span class="sd">                    ...</span>
<span class="sd">                    &gt;&gt;&gt; femopt.add_constraint(constraint, lower_bound=5)  # doctest: +SKIP</span>

<span class="sd">                Instead, please do the following.</span>

<span class="sd">                    &gt;&gt;&gt; def bottom_area(_, opt):  # Not to access the 1st argument.  # doctest: +SKIP</span>
<span class="sd">                    ...     params = opt.get_parameter()  # doctest: +SKIP</span>
<span class="sd">                    ...     w, d = params[&#39;width&#39;], params[&#39;depth&#39;]  # doctest: +SKIP</span>
<span class="sd">                    ...     return w * d  # doctest: +SKIP</span>
<span class="sd">                    ...</span>
<span class="sd">                    &gt;&gt;&gt; femopt.add_constraint(constraint, lower_bound=5, args=(femopt.opt,))  # doctest: +SKIP</span>

<span class="sd">        Note:</span>
<span class="sd">            If the FEMInterface is FemtetInterface, the 1st argument of fun should be Femtet (IPyDispatch) object.</span>

<span class="sd">        Tip:</span>
<span class="sd">            If name is None, name is a string with the prefix `&quot;cns_&quot;` followed by a sequential number.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 引数の処理</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">,)</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">Constraint</span><span class="o">.</span><span class="n">default_name</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">is_existing</span> <span class="o">=</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_existing</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">candidate</span>
        <span class="k">if</span> <span class="n">using_fem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># 自動推定機能は Femtet 特有の処理とする</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fem</span><span class="p">,</span> <span class="n">FemtetInterface</span><span class="p">):</span>
                <span class="n">using_fem</span> <span class="o">=</span> <span class="n">_is_access_femtet</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">using_fem</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># strict constraint の場合、solve 前に評価したいので Gogh へのアクセスを禁ずる</span>
        <span class="k">if</span> <span class="n">strict</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fem</span><span class="p">,</span> <span class="n">FemtetInterface</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">_is_access_gogh</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">Msg</span><span class="o">.</span><span class="n">ERR_CONTAIN_GOGH_ACCESS_IN_STRICT_CONSTRAINT</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="c1"># strict constraint かつ BoTorchSampler の場合、</span>
        <span class="c1"># 最適化実行時に monkey patch を実行するフラグを立てる。</span>
        <span class="c1"># ただし using_fem が True ならば非常に低速なので警告を出す。</span>
        <span class="k">if</span> <span class="n">strict</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">,</span> <span class="n">OptunaOptimizer</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">:</span> <span class="n">OptunaOptimizer</span>
            <span class="kn">from</span> <span class="nn">optuna_integration</span> <span class="kn">import</span> <span class="n">BoTorchSampler</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">sampler_class</span><span class="p">,</span> <span class="n">BoTorchSampler</span><span class="p">):</span>
                <span class="c1"># パッチ実行フラグ</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">_do_monkey_patch</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># 警告</span>
                <span class="k">if</span> <span class="n">using_fem</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">Msg</span><span class="o">.</span><span class="n">WARN_UPDATE_FEM_PARAMETER_TOOK_A_LONG_TIME</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">constraints</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Constraint</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">,</span> <span class="n">strict</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">using_fem</span><span class="p">)</span></div>


<div class="viewcode-block" id="FEMOpt.get_parameter">
<a class="viewcode-back" href="../../../modules/pyfemtet.opt.html#pyfemtet.opt.FEMOpt.get_parameter">[docs]</a>
    <span class="k">def</span> <span class="nf">get_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;dict&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deprecated method.</span>

<span class="sd">        Planed to remove in future version. Use FEMOpt.opt.get_parameter() instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">DeprecationWarning</span><span class="p">(</span><span class="s1">&#39;FEMOpt.get_parameter() was deprecated. Use FEMOpt.opt.get_parameter() instead.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FEMOpt.set_monitor_host">
<a class="viewcode-back" href="../../../modules/pyfemtet.opt.html#pyfemtet.opt.FEMOpt.set_monitor_host">[docs]</a>
    <span class="k">def</span> <span class="nf">set_monitor_host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the host IP address and the port of the process monitor.</span>

<span class="sd">        Args:</span>
<span class="sd">            host (str):</span>
<span class="sd">                The hostname or IP address of the monitor server.</span>
<span class="sd">            port (int, optional):</span>
<span class="sd">                The port number of the monitor server.</span>
<span class="sd">                If None, ``8080`` will be used.</span>
<span class="sd">                Defaults to None.</span>

<span class="sd">        Tip:</span>
<span class="sd">            Specifying host ``0.0.0.0`` allows viewing monitor</span>
<span class="sd">            from all computers on the local network.</span>

<span class="sd">            If no hostname is specified, the monitor server</span>
<span class="sd">            will be hosted on ``localhost``.</span>

<span class="sd">            We can access process monitor by accessing</span>
<span class="sd">            ```localhost:8080``` on our browser by default.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_server_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="n">port</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="FEMOpt.optimize">
<a class="viewcode-back" href="../../../modules/pyfemtet.opt.html#pyfemtet.opt.FEMOpt.optimize">[docs]</a>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">n_trials</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">n_parallel</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">wait_setup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">confirm_before_exit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs the main optimization process.</span>

<span class="sd">        Args:</span>
<span class="sd">            n_trials (int, optional):</span>
<span class="sd">                The number of trials.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            n_parallel (int, optional):</span>
<span class="sd">                The number of parallel processes.</span>
<span class="sd">                Defaults to 1.</span>
<span class="sd">                Note that even if this argument is 1,</span>
<span class="sd">                :class:`FEMOpt` makes some child processes</span>
<span class="sd">                to run process monitor, status monitor, etc.</span>
<span class="sd">            timeout (float, optional):</span>
<span class="sd">                The maximum amount of time in seconds</span>
<span class="sd">                that each trial can run.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            wait_setup (bool, optional):</span>
<span class="sd">                Wait for all workers launching FEM system.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            confirm_before_exit (bool, optional):</span>
<span class="sd">                Insert stop before exit to continue to</span>
<span class="sd">                show process monitor.</span>

<span class="sd">        Tip:</span>
<span class="sd">            If set_monitor_host() is not executed,</span>
<span class="sd">            a local server for monitoring will be</span>
<span class="sd">            started at localhost:8080.</span>

<span class="sd">            See Also:</span>
<span class="sd">                :func:`FEMOpt.set_monitor_host`</span>

<span class="sd">        Note:</span>
<span class="sd">            If ``n_trials`` and ``timeout`` are both None,</span>
<span class="sd">            it runs forever until interrupting by the user.</span>

<span class="sd">        Note:</span>
<span class="sd">            If ``n_parallel`` &gt;= 2, depending on the end timing,</span>
<span class="sd">            ``n_trials`` may be exceeded by up to ``n_parallel-1`` times.</span>

<span class="sd">        Warning:</span>
<span class="sd">            If ``n_parallel`` &gt;= 2 and ``fem`` is a subclass of</span>
<span class="sd">            ``FemtetInterface``, the ``strictly_pid_specify`` of</span>
<span class="sd">            subprocess is set to ``False``.</span>
<span class="sd">            So **it is recommended to close all other Femtet processes</span>
<span class="sd">            before running.**</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># ===== opt の設定 =====</span>

        <span class="c1"># Interface から設定を読む場合の処理</span>
        <span class="c1"># 設定ファイルから設定を読む場合は最適化問題が</span>
        <span class="c1"># この時点で不定なので actor 等の設定をする前に</span>
        <span class="c1"># ここで確定する必要がある。</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fem</span><span class="p">,</span> <span class="s1">&#39;_load_problem_from_me&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">_load_problem_from_me</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">load_parameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">load_objective</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">load_constraint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">)</span>

        <span class="c1"># resolve expression dependencies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>

        <span class="c1"># opt の共通引数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">n_trials</span> <span class="o">=</span> <span class="n">n_trials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>

        <span class="c1"># method checker</span>
        <span class="k">if</span> <span class="n">n_parallel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">method_checker</span><span class="o">.</span><span class="n">check_parallel</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">method_checker</span><span class="o">.</span><span class="n">check_timeout</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">objectives</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">method_checker</span><span class="o">.</span><span class="n">check_multi_objective</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">method_checker</span><span class="o">.</span><span class="n">check_constraint</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">strict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">method_checker</span><span class="o">.</span><span class="n">check_strict_constraint</span><span class="p">()</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">method_checker</span><span class="o">.</span><span class="n">check_seed</span><span class="p">()</span>

        <span class="n">is_incomplete_bounds</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">prm</span><span class="p">:</span> <span class="n">Parameter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">prm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="n">prm</span><span class="o">.</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">prm</span><span class="o">.</span><span class="n">upper_bound</span>
            <span class="n">is_incomplete_bounds</span> <span class="o">=</span> <span class="n">is_incomplete_bounds</span> <span class="o">+</span> <span class="p">(</span><span class="n">lb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_incomplete_bounds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">method_checker</span><span class="o">.</span><span class="n">check_incomplete_bounds</span><span class="p">()</span>


        <span class="c1"># ===== fem の設定 ==--=</span>

        <span class="c1"># Femtet 特有の処理</span>
        <span class="n">extra_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fem</span><span class="p">,</span> <span class="n">FemtetInterface</span><span class="p">):</span>

            <span class="c1"># 結果 csv に記載する femprj に関する情報の作成</span>
            <span class="n">extra_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">femprj_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">original_femprj_path</span><span class="p">,</span>
                    <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">model_name</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Femtet の parametric 設定を目的関数に用いるかどうか</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">parametric_output_indexes_use_as_objective</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">pyfemtet.opt.interface._femtet_parametric</span> <span class="kn">import</span> <span class="n">add_parametric_results_as_objectives</span>
                <span class="n">indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">parametric_output_indexes_use_as_objective</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">directions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">parametric_output_indexes_use_as_objective</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">add_parametric_results_as_objectives</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">indexes</span><span class="p">,</span>
                    <span class="n">directions</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Femtet loaded successfully.&#39;</span><span class="p">)</span>

        <span class="c1"># クラスターの設定</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">is_cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler_address</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">is_cluster</span><span class="p">:</span>
            <span class="c1"># 既存のクラスターに接続</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Connecting to existing cluster.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler_address</span><span class="p">)</span>

            <span class="c1"># 最適化タスクを振り分ける worker を指定</span>
            <span class="n">subprocess_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_parallel</span><span class="p">))</span>
            <span class="n">worker_addresses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">nthreads</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># worker が足りない場合はエラー</span>
            <span class="k">if</span> <span class="n">n_parallel</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">worker_addresses</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;n_parallel(</span><span class="si">{</span><span class="n">n_parallel</span><span class="si">}</span><span class="s1">) &gt; n_workers(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">worker_addresses</span><span class="p">)</span><span class="si">}</span><span class="s1">). There are insufficient number of workers.&#39;</span><span class="p">)</span>

            <span class="c1"># worker が多い場合は閉じる</span>
            <span class="k">if</span> <span class="n">n_parallel</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">worker_addresses</span><span class="p">):</span>
                <span class="n">used_worker_addresses</span> <span class="o">=</span> <span class="n">worker_addresses</span><span class="p">[:</span><span class="n">n_parallel</span><span class="p">]</span>  <span class="c1"># 前から順番に選ぶ：CPU の早い / メモリの多い順に並べることが望ましい</span>
                <span class="n">unused_worker_addresses</span> <span class="o">=</span> <span class="n">worker_addresses</span><span class="p">[</span><span class="n">n_parallel</span><span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">retire_workers</span><span class="p">(</span><span class="n">unused_worker_addresses</span><span class="p">,</span> <span class="n">close_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">worker_addresses</span> <span class="o">=</span> <span class="n">used_worker_addresses</span>

            <span class="c1"># monitor worker の設定</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Launching monitor server. This may take a few seconds.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_process_worker_name</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;Monitor%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S&quot;</span><span class="p">)</span>
            <span class="n">add_worker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_process_worker_name</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ローカルクラスターを構築</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Launching single machine cluster... This may take tens of seconds.&#39;</span><span class="p">)</span>

            <span class="c1"># Fixed:</span>
            <span class="c1">#   Nanny の管理機能は必要ないが、Python API では worker_class を Worker にすると</span>
            <span class="c1">#   processes 引数が無視されて Thread worker が立てられる。</span>
            <span class="c1">#   これは CLI の --no-nanny オプションも同様らしい。</span>

            <span class="c1"># クラスターの構築</span>
            <span class="c1"># noinspection PyTypeChecker</span>
            <span class="n">cluster</span> <span class="o">=</span> <span class="n">LocalCluster</span><span class="p">(</span>
                <span class="n">processes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">n_workers</span><span class="o">=</span><span class="n">n_parallel</span><span class="p">,</span>
                <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">worker_class</span><span class="o">=</span><span class="n">Nanny</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;LocalCluster launched successfully.&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span>
                <span class="n">cluster</span><span class="p">,</span>
                <span class="n">direct_to_workers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Client launched successfully.&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">address</span>

            <span class="c1"># worker address を取得</span>
            <span class="n">nannies_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Nanny</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">workers</span>
            <span class="n">nannies</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">nannies_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

            <span class="c1"># ひとつの Nanny を選んで monitor 用にしつつ</span>
            <span class="c1"># その space は main process に使わせるために記憶する</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_process_worker_name</span> <span class="o">=</span> <span class="n">nannies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">worker_address</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extra_space_dir</span> <span class="o">=</span> <span class="n">nannies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">worker_dir</span>

            <span class="c1"># 名前と address がごちゃごちゃになっていて可読性が悪いが</span>
            <span class="c1"># 選んだ以外の Nanny は計算を割り当てる用にする</span>
            <span class="n">worker_addresses</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Main&#39;</span><span class="p">]</span>
            <span class="n">worker_addresses</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">worker_address</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nannies</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span>
            <span class="n">subprocess_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_parallel</span><span class="p">))[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">cluster</span> <span class="k">as</span> <span class="n">_cluster</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="k">as</span> <span class="n">_client</span><span class="p">:</span>

            <span class="c1"># ===== status actor の設定 =====</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OptimizationStatus</span><span class="p">(</span><span class="n">_client</span><span class="p">,</span> <span class="n">worker_address</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_process_worker_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worker_status_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">OptimizationStatus</span><span class="p">(</span><span class="n">_client</span><span class="p">,</span> <span class="n">worker_address</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_process_worker_name</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">worker_addresses</span><span class="p">]</span>  <span class="c1"># tqdm 検討</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">OptimizationStatus</span><span class="o">.</span><span class="n">SETTING_UP</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_host_record</span> <span class="o">=</span> <span class="n">MonitorHostRecord</span><span class="p">(</span><span class="n">_client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_process_worker_name</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Status Actor initialized successfully.&#39;</span><span class="p">)</span>

            <span class="c1"># ===== initialize history =====</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">History</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history_path</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">get_parameter_names</span><span class="p">(),</span>
                <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">objectives</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                <span class="n">_client</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_hv_reference</span>
            <span class="p">)</span>

            <span class="c1"># ===== launch monitor =====</span>
            <span class="c1"># launch monitor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_process_future</span> <span class="o">=</span> <span class="n">_client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                <span class="c1"># func</span>
                <span class="n">_start_monitor_server</span><span class="p">,</span>
                <span class="c1"># args</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                <span class="n">worker_addresses</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">worker_status_list</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">monitor_host_record</span><span class="p">,</span>
                <span class="c1"># kwargs</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_server_kwargs</span><span class="p">,</span>
                <span class="c1"># kwargs of submit</span>
                <span class="n">workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_process_worker_name</span><span class="p">,</span>
                <span class="n">allow_other_workers</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process monitor initialized successfully.&#39;</span><span class="p">)</span>

            <span class="c1"># update extra_data of history to notify</span>
            <span class="c1"># how to emit interruption signal by</span>
            <span class="c1"># external processes</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_host_record</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">extra_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_host_record</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">extra_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_data</span><span class="p">)</span>

            <span class="c1"># ===== setup fem and opt before parallelization =====</span>
            <span class="c1"># fem</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">_setup_before_parallel</span><span class="p">(</span><span class="n">_client</span><span class="p">)</span>

            <span class="c1"># opt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">fem_class</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fem</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">fem_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">kwargs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">entire_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">_setup_before_parallel</span><span class="p">()</span>

            <span class="c1"># ===== 最適化ループ開始 =====</span>
            <span class="c1"># opt から non-serializable な com を</span>
            <span class="c1"># 有している可能性のある fem を削除</span>
            <span class="c1"># ただし main process の sub thread では</span>
            <span class="c1"># これをそのまま使うので buff に退避</span>
            <span class="n">buff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">fem</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">fem</span>

            <span class="c1"># クラスターでの計算開始</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">OptimizationStatus</span><span class="o">.</span><span class="n">LAUNCHING_FEM</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="n">calc_futures</span> <span class="o">=</span> <span class="n">_client</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">_run</span><span class="p">,</span>
                <span class="n">subprocess_indices</span><span class="p">,</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_status_list</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">subprocess_indices</span><span class="p">),</span>
                <span class="p">[</span><span class="n">wait_setup</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">subprocess_indices</span><span class="p">),</span>
                <span class="n">workers</span><span class="o">=</span><span class="n">worker_addresses</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">is_cluster</span> <span class="k">else</span> <span class="n">worker_addresses</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                <span class="n">allow_other_workers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># 退避した fem を戻す</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">fem</span> <span class="o">=</span> <span class="n">buff</span>

            <span class="c1"># リモートクラスタではない場合</span>
            <span class="c1"># main process の sub thread で</span>
            <span class="c1"># 計算開始</span>
            <span class="n">t_main</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">is_cluster</span><span class="p">:</span>
                <span class="c1"># ローカルプロセスでの計算(opt._run 相当の処理)</span>
                <span class="n">subprocess_idx</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># set_fem</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">fem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fem</span>

                <span class="c1"># fem の _setup_after_parallel はこの場合も呼ばれる</span>
                <span class="n">t_main</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">_run</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">subprocess_idx</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">worker_status_list</span><span class="p">,</span>
                        <span class="n">wait_setup</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">skip_reconstruct</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">space_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extra_space_dir</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">t_main</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="c1"># ===== save history during optimization =====</span>
            <span class="k">def</span> <span class="nf">save_history</span><span class="p">():</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">Msg</span><span class="o">.</span><span class="n">WARN_HISTORY_CSV_NOT_ACCESSIBLE</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">OptimizationStatus</span><span class="o">.</span><span class="n">TERMINATED</span><span class="p">:</span>
                        <span class="k">break</span>

            <span class="n">t_save_history</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">save_history</span><span class="p">)</span>
            <span class="n">t_save_history</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="c1"># ===== 終了 =====</span>
            <span class="c1"># クラスターの Unexpected Exception のリストを取得</span>
            <span class="n">opt_exceptions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="ne">Exception</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">_client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">calc_futures</span><span class="p">)</span>  <span class="c1"># gather() で終了待ちも兼ねる</span>

            <span class="c1"># ローカルの opt で計算している場合、その Exception も取得</span>
            <span class="n">local_opt_exception</span><span class="p">:</span> <span class="ne">Exception</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">is_cluster</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t_main</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">t_main</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>  <span class="c1"># 終了待ち</span>
                    <span class="n">local_opt_exception</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">_exception</span>  <span class="c1"># Exception を取得</span>
            <span class="n">opt_exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_opt_exception</span><span class="p">)</span>

            <span class="c1"># 終了シグナルを送る</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">OptimizationStatus</span><span class="o">.</span><span class="n">TERMINATED</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

            <span class="c1"># 一応</span>
            <span class="n">t_save_history</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

            <span class="c1"># 結果通知</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">Msg</span><span class="o">.</span><span class="n">OPTIMIZATION_FINISHED</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

            <span class="c1"># monitor worker を終了する準備</span>
            <span class="c1"># 実際の終了は monitor worker の終了時</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">OptimizationStatus</span><span class="o">.</span><span class="n">TERMINATE_ALL</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_process_future</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># monitor が terminated 状態で少なくとも一度更新されなければ running のまま固まる</span>

            <span class="c1"># 全ての Exception を再表示</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">opt_exception</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">opt_exceptions</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">opt_exception</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;===== unexpected exception raised on worker </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> =====&#39;</span><span class="p">)</span>
                    <span class="n">print_exception</span><span class="p">(</span><span class="n">opt_exception</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">()</span>

            <span class="c1"># monitor worker を残してユーザーが結果を確認できるようにする</span>
            <span class="c1"># with 文を抜けると monitor worker が終了して</span>
            <span class="c1"># daemon thread である run_forever が終了する</span>
            <span class="k">if</span> <span class="n">confirm_before_exit</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">Msg</span><span class="o">.</span><span class="n">CONFIRM_BEFORE_EXIT</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">Msg</span><span class="o">.</span><span class="n">CONFIRM_BEFORE_EXIT</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">Msg</span><span class="o">.</span><span class="n">CONFIRM_BEFORE_EXIT</span><span class="p">))</span>
                <span class="nb">input</span><span class="p">()</span>

            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">get_df</span><span class="p">()</span>  <span class="c1"># with 文を抜けると actor は消えるが .copy() はこの段階では不要</span>

        <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="FEMOpt.terminate_all">
<a class="viewcode-back" href="../../../modules/pyfemtet.opt.html#pyfemtet.opt.FEMOpt.terminate_all">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">terminate_all</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deprecated method. We plan to remove this in future version.</span>

<span class="sd">        In current version, the termination processes are</span>
<span class="sd">        automatically execute in the last of :func:`FEMOpt.optimize`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;terminate_all() is deprecated and will be removed in a future version. &quot;</span>
            <span class="s2">&quot;In current and later versions, the equivalent of terminate_all() will be executed when optimize() finishes. &quot;</span>
            <span class="s2">&quot;Therefore, you can simply remove terminate_all() from your code. &quot;</span>
            <span class="s2">&quot;If you want to stop program before terminating monitor process, &quot;</span>
            <span class="s2">&quot;use ``confirm_before_exit`` argument like ``FEMOpt.optimize(confirm_before_exit=True)``&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span></div>
</div>



<span class="k">def</span> <span class="nf">_start_monitor_server</span><span class="p">(</span>
        <span class="n">history</span><span class="p">,</span>
        <span class="n">status</span><span class="p">,</span>
        <span class="n">worker_addresses</span><span class="p">,</span>
        <span class="n">worker_status_list</span><span class="p">,</span>
        <span class="n">host_record</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">process_monitor_main</span><span class="p">(</span>
        <span class="n">history</span><span class="p">,</span>
        <span class="n">status</span><span class="p">,</span>
        <span class="n">worker_addresses</span><span class="p">,</span>
        <span class="n">worker_status_list</span><span class="p">,</span>
        <span class="n">host</span><span class="p">,</span>
        <span class="n">port</span><span class="p">,</span>
        <span class="n">host_record</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;Exit monitor server process gracefully&#39;</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Kazuma Naito.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>